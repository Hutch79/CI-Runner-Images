name: PR Validation

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'images/**'
      - '.github/workflows/**'
      - '.github/actions/**'

jobs:
  detect-changes:
    uses: ./.github/workflows/detect-changes.yml
    secrets: inherit

  lint-dockerfiles:
    uses: ./.github/workflows/lint-dockerfiles.yml
    secrets: inherit

  build-images:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    uses: ./.github/workflows/validate-images.yml
    with:
      changed-images: ${{ needs.detect-changes.outputs.changed-images }}
    secrets: inherit

  security-scan:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    uses: ./.github/workflows/security-scan.yml
    with:
      changed-images: ${{ needs.detect-changes.outputs.changed-images }}
    secrets: inherit

  image-analysis:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    uses: ./.github/workflows/image-analysis.yml
    with:
      changed-images: ${{ needs.detect-changes.outputs.changed-images }}
    secrets: inherit

  summary:
    needs: [detect-changes, lint-dockerfiles, build-images, security-scan, image-analysis]
    uses: ./.github/workflows/validation-summary.yml
    with:
      detect-changes-result: ${{ needs.detect-changes.result }}
      lint-dockerfiles-result: ${{ needs.lint-dockerfiles.result }}
      build-images-result: ${{ needs.build-images.result }}
      security-scan-result: ${{ needs.security-scan.result }}
      image-analysis-result: ${{ needs.image-analysis.result }}
      changed-images: ${{ needs.detect-changes.outputs.changed-images }}
      has-changes: ${{ needs.detect-changes.outputs.has-changes }}
    secrets: inherit
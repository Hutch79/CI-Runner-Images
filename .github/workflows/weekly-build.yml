name: Weekly Build and Publish Images

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      publish_release_tags:
        description: 'Also publish release tags (without date)'
        required: false
        default: true
        type: boolean
      use_cache:
        description: 'Use build cache for faster builds'
        required: false
        default: true
        type: boolean

jobs:
  discover-images:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.find-images.outputs.images }}
      matrix: ${{ steps.find-images.outputs.matrix }}
      dotnet-images: ${{ steps.find-images.outputs.dotnet-images }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find image directories
      id: find-images
      run: |
        # Find all directories in images/ that contain a Dockerfile
        ALL_IMAGES=$(find images -name "Dockerfile" -exec dirname {} \; | sort)
        echo "Found images: $ALL_IMAGES"

        # Separate base from others
        BASE_IMAGE="images/base"
        DOTNET_IMAGES=$(echo "$ALL_IMAGES" | grep -v "^$BASE_IMAGE$")

        # Create JSON array for dotnet images matrix
        MATRIX_JSON=$(echo "$DOTNET_IMAGES" | jq -R -s -c 'split("\n") | map(select(. != "")) | map({image: .})')
        echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

        # Also output space-separated for compatibility
        ALL_IMAGES_SPACE=$(echo "$ALL_IMAGES" | tr '\n' ' ')
        DOTNET_IMAGES_SPACE=$(echo "$DOTNET_IMAGES" | tr '\n' ' ')
        echo "images=$ALL_IMAGES_SPACE" >> $GITHUB_OUTPUT
        echo "dotnet-images=$DOTNET_IMAGES_SPACE" >> $GITHUB_OUTPUT

  smoke-tests:
    needs: discover-images
    uses: ./.github/workflows/smoke-tests.yml
    with:
      run_all: true
    secrets: inherit

  integration-tests:
    needs: smoke-tests
    uses: ./.github/workflows/integration-tests.yml
    with:
      run_all: true
    secrets: inherit

  build-base:
    needs: [discover-images, integration-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download smoke test results for base
      uses: actions/download-artifact@v4
      with:
        name: smoke-test-result-images/base
        path: /tmp/smoke-results

    - name: Download integration test results for base
      uses: actions/download-artifact@v4
      with:
        name: integration-test-result-images/base
        path: /tmp/integration-results

    - name: Check base image test results
      run: |
        # Check if base passed smoke tests
        if ! grep -q "base:passed" /tmp/smoke-results/smoke-test-results.txt; then
          echo "Base image failed smoke tests, skipping build"
          exit 1
        fi
        
        # Check if base passed integration tests
        if ! grep -q "base:passed" /tmp/integration-results/integration-test-results.txt; then
          echo "Base image failed integration tests, skipping build"
          exit 1
        fi
        
        echo "Base image passed all tests, proceeding with build"

    - name: Build and push base image
      uses: ./.github/actions/ci-image-builder
      with:
        image-dir: images/base
        registry: ghcr.io
        repository-owner: hutch79
        repository-name: ci-runner-images
        publish-release-tag: ${{ github.event.inputs.publish_release_tags == 'true' || github.event_name == 'schedule' }}
        use-cache: ${{ github.event_name != 'schedule' }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

  build-and-publish:
    needs: [discover-images, build-base, integration-tests]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.discover-images.outputs.matrix) }}
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download smoke test results
      uses: actions/download-artifact@v4
      with:
        name: smoke-test-result-${{ matrix.image }}
        path: /tmp/smoke-results

    - name: Download integration test results
      uses: actions/download-artifact@v4
      with:
        name: integration-test-result-${{ matrix.image }}
        path: /tmp/integration-results

    - name: Check image test results
      run: |
        IMAGE_DIR="${{ matrix.image }}"
        FOLDER_NAME=$(basename "$IMAGE_DIR")
        
        # Check if image passed smoke tests
        if ! grep -q "$FOLDER_NAME:passed" /tmp/smoke-results/smoke-test-results.txt; then
          echo "$FOLDER_NAME failed smoke tests, skipping build"
          exit 1
        fi
        
        # Check if image passed integration tests
        if ! grep -q "$FOLDER_NAME:passed" /tmp/integration-results/integration-test-results.txt; then
          echo "$FOLDER_NAME failed integration tests, skipping build"
          exit 1
        fi
        
        echo "$FOLDER_NAME passed all tests, proceeding with build"

    - name: Build and push image
      uses: ./.github/actions/ci-image-builder
      with:
        image-dir: ${{ matrix.image }}
        registry: ghcr.io
        repository-owner: hutch79
        repository-name: ci-runner-images
        publish-release-tag: ${{ github.event.inputs.publish_release_tags == 'true' || github.event_name == 'schedule' }}
        use-cache: ${{ github.event_name != 'schedule' }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    needs: [discover-images, build-base, build-and-publish, smoke-tests, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      packages: read
    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate summary
      run: |
        DATE=$(date +'%Y%m%d')
        RELEASE_TAG="${{ github.event.inputs.publish_release_tags == 'true' || github.event_name == 'schedule' }}"
        
        # Check overall workflow status
        BUILD_BASE_STATUS="${{ needs.build-base.result }}"
        BUILD_PUBLISH_STATUS="${{ needs.build-and-publish.result }}"
        
        if [ "$BUILD_BASE_STATUS" = "success" ] && [ "$BUILD_PUBLISH_STATUS" = "success" ]; then
          OVERALL_STATUS="✅ **SUCCESS**"
        else
          OVERALL_STATUS="❌ **FAILED**"
        fi

        echo "## $OVERALL_STATUS - Published Images" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $DATE" >> $GITHUB_STEP_SUMMARY
        echo "**Base Build:** $BUILD_BASE_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "**Other Builds:** $BUILD_PUBLISH_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Image | Size | Dated Tag | Release Tag | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|-----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

        # Read images from the output (space-separated)
        IMAGES="${{ needs.discover-images.outputs.images }}"

        for image_dir in $IMAGES; do
          folder_name=$(basename "$image_dir")
          dated_tag="ghcr.io/hutch79/ci-runner-images:$folder_name-$DATE"
          release_tag="ghcr.io/hutch79/ci-runner-images:$folder_name"

          # Determine job status based on which job handles this image
          if [ "$folder_name" = "base" ]; then
            job_result="$BUILD_BASE_STATUS"
          else
            job_result="$BUILD_PUBLISH_STATUS"
          fi

          if [ "$job_result" = "success" ]; then
            job_status="✅ Success"
            # Get image size from registry by pulling and checking
            IMAGE_SIZE="Unknown"
            if docker pull "$dated_tag" >/dev/null 2>&1; then
              # Get size from docker images output
              RAW_SIZE=$(docker images "$dated_tag" --format "table {{.Size}}" | tail -n 1 2>/dev/null || echo "")
              if [ -n "$RAW_SIZE" ] && [ "$RAW_SIZE" != "<none>" ]; then
                IMAGE_SIZE="$RAW_SIZE"
              fi
              # Clean up the pulled image
              docker rmi "$dated_tag" >/dev/null 2>&1 || true
            fi
          else
            job_status="❌ Failed ($job_result)"
            IMAGE_SIZE="N/A"
          fi

          if [ "$RELEASE_TAG" = "true" ]; then
            echo "| $folder_name | $IMAGE_SIZE | \`$dated_tag\` | \`$release_tag\` | $job_status |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| $folder_name | $IMAGE_SIZE | \`$dated_tag\` | - | $job_status |" >> $GITHUB_STEP_SUMMARY
          fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Run" >> $GITHUB_STEP_SUMMARY
        echo "This workflow runs weekly on Mondays at 00:00 UTC." >> $GITHUB_STEP_SUMMARY
name: Weekly Build and Publish Images

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      publish_release_tags:
        description: 'Also publish release tags (without date)'
        required: false
        default: 'true'
        type: boolean
      use_cache:
        description: 'Use build cache for faster builds'
        required: false
        default: 'true'
        type: boolean

jobs:
  discover-images:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.find-images.outputs.images }}
      matrix: ${{ steps.find-images.outputs.matrix }}
      dotnet-images: ${{ steps.find-images.outputs.dotnet-images }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find image directories
      id: find-images
      run: |
        # Find all directories in images/ that contain a Dockerfile
        ALL_IMAGES=$(find images -name "Dockerfile" -exec dirname {} \; | sort)
        echo "Found images: $ALL_IMAGES"

        # Separate base from others
        BASE_IMAGE="images/base"
        DOTNET_IMAGES=$(echo "$ALL_IMAGES" | grep -v "^$BASE_IMAGE$")

        # Create JSON array for dotnet images matrix
        MATRIX_JSON=$(echo "$DOTNET_IMAGES" | jq -R -s -c 'split("\n") | map(select(. != "")) | map({image: .})')
        echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

        # Also output space-separated for compatibility
        ALL_IMAGES_SPACE=$(echo "$ALL_IMAGES" | tr '\n' ' ')
        DOTNET_IMAGES_SPACE=$(echo "$DOTNET_IMAGES" | tr '\n' ' ')
        echo "images=$ALL_IMAGES_SPACE" >> $GITHUB_OUTPUT
        echo "dotnet-images=$DOTNET_IMAGES_SPACE" >> $GITHUB_OUTPUT

  build-base:
    needs: discover-images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build and push base image
      uses: ./.github/actions/ci-image-builder
      with:
        image-dir: images/base
        registry: ghcr.io
        repository-owner: hutch79
        repository-name: ci-runner-images
        publish-release-tag: ${{ github.event.inputs.publish_release_tags == 'true' || github.event_name == 'schedule' }}
        use-cache: ${{ github.event_name != 'schedule' }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

  build-and-publish:
    needs: [discover-images, build-base]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-images.outputs.matrix) }}
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Wait for base image to be available
      run: |
        echo "Waiting for base image to be available..."
        for i in {1..7}; do
          echo "Attempt $i: Checking base image manifest..."
          if docker buildx imagetools inspect ghcr.io/hutch79/ci-runner-images:base >/dev/null 2>&1; then
            echo "✅ Base image manifest is available"
            # Also verify it has the expected platforms
            if docker buildx imagetools inspect ghcr.io/hutch79/ci-runner-images:base | grep -q "linux/amd64\|linux/arm64"; then
              echo "✅ Base image has expected platforms"
              break
            else
              echo "❌ Base image manifest exists but missing expected platforms"
            fi
          else
            echo "❌ Base image manifest not yet available"
          fi
          if [ $i -lt 7 ]; then
            echo "Retrying in 10 seconds... ($i/7)"
            sleep 10
          fi
        done
        if [ $i -eq 7 ]; then
          echo "❌ Base image manifest still not available after 1 minute"
          exit 1
        fi
      shell: bash

    - name: Build and push image
      uses: ./.github/actions/ci-image-builder
      with:
        image-dir: ${{ matrix.image }}
        registry: ghcr.io
        repository-owner: hutch79
        repository-name: ci-runner-images
        publish-release-tag: ${{ github.event.inputs.publish_release_tags == 'true' || github.event_name == 'schedule' }}
        use-cache: ${{ github.event_name != 'schedule' }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    needs: [discover-images, build-base, build-and-publish]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
      packages: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate summary
      run: |
        DATE=$(date +'%Y%m%d')
        RELEASE_TAG="${{ github.event.inputs.publish_release_tags == 'true' || github.event_name == 'schedule' }}"
        SHA="${{ github.sha }}"
        SHORT_SHA="${SHA:0:8}"

        # Check overall workflow status
        BUILD_BASE_STATUS="${{ needs.build-base.result }}"
        BUILD_PUBLISH_STATUS="${{ needs.build-and-publish.result }}"
        
        if [ "$BUILD_BASE_STATUS" = "success" ] && [ "$BUILD_PUBLISH_STATUS" = "success" ]; then
          OVERALL_STATUS="✅ **SUCCESS**"
        else
          OVERALL_STATUS="❌ **FAILED**"
        fi

        echo "## $OVERALL_STATUS - Published Images" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`$SHA\`" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $DATE" >> $GITHUB_STEP_SUMMARY
        echo "**Base Build:** $BUILD_BASE_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "**Other Builds:** $BUILD_PUBLISH_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Image | Size | Dated Tag | Release Tag | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|------|-----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

        # Read images from the output (space-separated)
        IMAGES="${{ needs.discover-images.outputs.images }}"

        for image_dir in $IMAGES; do
          folder_name=$(basename "$image_dir")
          dated_tag="ghcr.io/hutch79/ci-runner-images:$folder_name-$DATE"
          release_tag="ghcr.io/hutch79/ci-runner-images:$folder_name"

          # Determine job status based on which job handles this image
          if [ "$folder_name" = "base" ]; then
            job_result="$BUILD_BASE_STATUS"
          else
            job_result="$BUILD_PUBLISH_STATUS"
          fi

          if [ "$job_result" = "success" ]; then
            # Check if image can actually be pulled
            if docker pull "$dated_tag" 2>/dev/null; then
              job_status="✅ Success"
              # Get image size in human readable format
              IMAGE_SIZE=$(docker images "$dated_tag" --format "table {{.Size}}" | tail -n 1)
              if [ -z "$IMAGE_SIZE" ] || [ "$IMAGE_SIZE" = "<none>" ]; then
                IMAGE_SIZE="Unknown"
              fi
            else
              job_status="❌ Failed (pull error)"
              IMAGE_SIZE="N/A"
            fi
          else
            job_status="❌ Failed ($job_result)"
            IMAGE_SIZE="N/A"
          fi

          if [ "$RELEASE_TAG" = "true" ]; then
            echo "| $folder_name | $IMAGE_SIZE | \`$dated_tag\` | \`$release_tag\` | $job_status |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| $folder_name | $IMAGE_SIZE | \`$dated_tag\` | - | $job_status |" >> $GITHUB_STEP_SUMMARY
          fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Run" >> $GITHUB_STEP_SUMMARY
        echo "This workflow runs weekly on Mondays at 00:00 UTC." >> $GITHUB_STEP_SUMMARY
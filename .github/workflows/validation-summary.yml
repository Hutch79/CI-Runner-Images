name: Validation Summary

on:
  workflow_call:
    inputs:
      detect-changes-result:
        description: "Result of detect-changes job"
        required: true
        type: string
      lint-dockerfiles-result:
        description: "Result of lint-dockerfiles job"
        required: true
        type: string
      build-images-result:
        description: "Result of build-images job"
        required: true
        type: string
      security-scan-result:
        description: "Result of security-scan job"
        required: true
        type: string
      image-analysis-result:
        description: "Result of image-analysis job"
        required: true
        type: string
      changed-images:
        description: "JSON array of changed images"
        required: true
        type: string
      has-changes:
        description: "Whether any images have changes"
        required: true
        type: string

jobs:
  summary:
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: PR Validation Summary
      run: |
        echo "## ðŸ” PR Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.has-changes }}" = "true" ]; then
          echo "### ðŸ“¦ Images Built & Tested" >> $GITHUB_STEP_SUMMARY
          CHANGED_IMAGES="${{ inputs.changed-images }}"
          echo "$CHANGED_IMAGES" | jq -r '.[] | "- \(.image)"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ“¦ No Image Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "No images were modified in this PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Check job statuses with merge-blocking logic
        DETECT_STATUS="âœ…"
        LINT_STATUS="âœ…"
        BUILD_STATUS="âœ…"
        SECURITY_STATUS="âœ…"
        ANALYSIS_STATUS="âœ…"

        if [ "${{ inputs.detect-changes-result }}" != "success" ]; then DETECT_STATUS="âŒ"; fi
        if [ "${{ inputs.lint-dockerfiles-result }}" != "success" ]; then LINT_STATUS="âŒ"; fi
        if [ "${{ inputs.build-images-result }}" != "success" ] && [ "${{ inputs.build-images-result }}" != "skipped" ]; then BUILD_STATUS="âŒ"; fi
        if [ "${{ inputs.security-scan-result }}" != "success" ] && [ "${{ inputs.security-scan-result }}" != "skipped" ]; then SECURITY_STATUS="âŒ"; fi
        if [ "${{ inputs.image-analysis-result }}" != "success" ] && [ "${{ inputs.image-analysis-result }}" != "skipped" ]; then ANALYSIS_STATUS="âš ï¸"; fi

        echo "### âœ… Validation Checks" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status | Blocks Merge |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Detect Changes | $DETECT_STATUS | No |" >> $GITHUB_STEP_SUMMARY
        echo "| Lint Dockerfiles | $LINT_STATUS | Yes |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Images | $BUILD_STATUS | Yes |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | $SECURITY_STATUS | Yes |" >> $GITHUB_STEP_SUMMARY
        echo "| Image Analysis | $ANALYSIS_STATUS | No |" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Legend:** âœ… Pass | âŒ Fail (blocks merge) | âš ï¸ Warning | â„¹ï¸ Info" >> $GITHUB_STEP_SUMMARY